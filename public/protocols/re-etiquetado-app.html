<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Re-etiquetado - Transforma tu Lenguaje</title>
    <style>
        :root {
            --bg-primary: #FAF9F7;
            --bg-secondary: #F5F4F0;
            --text-primary: #1A1915;
            --text-secondary: #706F6C;
            --text-muted: #9B9A97;
            --border-color: #E5E4E0;
            --card-bg: #FFFFFF;
            --accent: #DA7756;
            --accent-light: rgba(218, 119, 86, 0.1);
            --success: #2ca58d;
            --success-light: rgba(44, 165, 141, 0.15);
            --old-phrase: #EF4444;
            --old-phrase-light: rgba(239, 68, 68, 0.1);
            --new-phrase: #10B981;
            --new-phrase-light: rgba(16, 185, 129, 0.1);
            --purple: #8B5CF6;
            --purple-light: rgba(139, 92, 246, 0.1);
            --blue: #3B82F6;
            --blue-light: rgba(59, 130, 246, 0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #121212;
                --bg-secondary: #252525;
                --text-primary: #ECECEC;
                --text-secondary: #B4B4B4;
                --text-muted: #808080;
                --border-color: #333333;
                --card-bg: #1E1E1E;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: none;
            border: none;
            color: var(--accent);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            padding: 8px 0;
        }

        .back-btn svg {
            width: 20px;
            height: 20px;
        }

        .header-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-spacer {
            width: 60px;
        }

        /* Screens */
        .screen {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .screen.active {
            display: flex;
        }

        /* Start Screen */
        .start-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            text-align: center;
        }

        .start-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--old-phrase-light), var(--new-phrase-light));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 28px;
            position: relative;
        }

        .start-icon::before {
            content: '';
            position: absolute;
            inset: 8px;
            background: var(--card-bg);
            border-radius: 50%;
        }

        .start-icon svg {
            width: 48px;
            height: 48px;
            color: var(--purple);
            position: relative;
            z-index: 1;
        }

        .start-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .start-description {
            font-size: 16px;
            color: var(--text-secondary);
            line-height: 1.6;
            max-width: 320px;
            margin-bottom: 32px;
        }

        .mechanism-box {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px 20px;
            margin-bottom: 32px;
            max-width: 340px;
        }

        .mechanism-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .mechanism-step {
            font-size: 12px;
            font-weight: 600;
            color: var(--purple);
            padding: 6px 12px;
            background: var(--purple-light);
            border-radius: 20px;
        }

        .mechanism-arrow {
            color: var(--text-muted);
            font-size: 14px;
        }

        .start-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 48px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(218, 119, 86, 0.3);
            transition: transform 0.2s;
        }

        .start-btn:active {
            transform: scale(0.98);
        }

        .start-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Mode Selection Screen */
        .mode-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
        }

        .mode-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .mode-header h2 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .mode-header p {
            font-size: 15px;
            color: var(--text-secondary);
        }

        .mode-cards {
            display: flex;
            flex-direction: column;
            gap: 16px;
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
        }

        .mode-card {
            background: var(--card-bg);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .mode-card:active {
            transform: scale(0.98);
        }

        .mode-card:hover {
            border-color: var(--accent);
        }

        .mode-card-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            font-size: 28px;
        }

        .mode-card-icon.predefined {
            background: var(--purple-light);
        }

        .mode-card-icon.predefined svg {
            width: 28px;
            height: 28px;
            color: var(--purple);
        }

        .mode-card-icon.custom {
            background: var(--blue-light);
        }

        .mode-card-icon.custom svg {
            width: 28px;
            height: 28px;
            color: var(--blue);
        }

        .mode-card h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .mode-card p {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .mode-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-secondary);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .mode-badge svg {
            width: 14px;
            height: 14px;
        }

        .mode-badge.ai {
            background: var(--blue-light);
            color: var(--blue);
        }

        /* Custom Screen */
        .custom-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
        }

        .custom-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .custom-header h2 {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .custom-header p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .custom-form {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-group textarea {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: 16px;
            font-size: 16px;
            font-family: inherit;
            resize: none;
            min-height: 100px;
            transition: border-color 0.2s;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: var(--blue);
        }

        .form-group textarea::placeholder {
            color: var(--text-muted);
        }

        .rate-limit-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .rate-limit-info svg {
            width: 18px;
            height: 18px;
            color: var(--text-secondary);
        }

        .rate-limit-info span {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .generate-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 18px;
            background: var(--blue);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
            transition: all 0.2s;
        }

        .generate-btn:active {
            transform: scale(0.98);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .generate-btn svg {
            width: 22px;
            height: 22px;
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            padding: 40px 20px;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-color);
            border-top-color: var(--blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-state p {
            font-size: 15px;
            color: var(--text-secondary);
        }

        .error-message {
            padding: 16px;
            background: var(--old-phrase-light);
            border: 1px solid var(--old-phrase);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .error-message p {
            font-size: 14px;
            color: var(--old-phrase);
            text-align: center;
        }

        .login-prompt {
            text-align: center;
            padding: 32px 20px;
        }

        .login-prompt p {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .login-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 28px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }

        /* Practice Screen */
        .practice-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .progress-bar {
            height: 4px;
            background: var(--border-color);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--purple), var(--new-phrase));
            transition: width 0.3s ease;
        }

        .practice-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            padding-bottom: 120px;
        }

        .practice-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .practice-step {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--purple);
            margin-bottom: 8px;
        }

        .practice-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Transform Card */
        .transform-card {
            background: var(--card-bg);
            border-radius: 24px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .transform-visual {
            padding: 24px;
        }

        .phrase-container {
            position: relative;
            margin-bottom: 16px;
        }

        .phrase-box {
            padding: 20px;
            border-radius: 16px;
            text-align: center;
        }

        .phrase-box.old {
            background: var(--old-phrase-light);
            border: 2px dashed var(--old-phrase);
            margin-bottom: 16px;
        }

        .phrase-box.new {
            background: var(--new-phrase-light);
            border: 2px solid var(--new-phrase);
        }

        .phrase-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .phrase-box.old .phrase-label { color: var(--old-phrase); }
        .phrase-box.new .phrase-label { color: var(--new-phrase); }

        .phrase-text {
            font-size: 20px;
            font-weight: 700;
            line-height: 1.3;
        }

        .phrase-box.old .phrase-text {
            color: var(--old-phrase);
            text-decoration: line-through;
            opacity: 0.7;
        }

        .phrase-box.new .phrase-text {
            color: var(--new-phrase);
        }

        .transform-arrow {
            display: flex;
            justify-content: center;
            padding: 8px 0;
        }

        .transform-arrow svg {
            width: 32px;
            height: 32px;
            color: var(--purple);
        }

        /* Practice Action Area */
        .practice-action {
            background: var(--bg-secondary);
            padding: 24px;
            text-align: center;
        }

        .action-instruction {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .action-sub {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .speak-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 18px 40px;
            background: var(--purple);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 20px rgba(139, 92, 246, 0.3);
        }

        .speak-btn:active {
            transform: scale(0.98);
        }

        .speak-btn.completed {
            background: var(--success);
            box-shadow: 0 4px 20px rgba(44, 165, 141, 0.3);
        }

        .speak-btn svg {
            width: 24px;
            height: 24px;
        }

        .speak-counter {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
        }

        .counter-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--border-color);
            transition: all 0.3s;
        }

        .counter-dot.active {
            background: var(--purple);
            transform: scale(1.2);
        }

        .counter-dot.completed {
            background: var(--success);
        }

        .speak-feedback {
            margin-top: 16px;
            padding: 12px 20px;
            background: var(--success-light);
            border-radius: 12px;
            display: none;
        }

        .speak-feedback.show {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .speak-feedback svg {
            width: 20px;
            height: 20px;
            color: var(--success);
        }

        .speak-feedback span {
            font-size: 14px;
            font-weight: 600;
            color: var(--success);
        }

        /* Effect Card */
        .effect-card {
            background: var(--card-bg);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            padding: 20px;
        }

        .effect-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .effect-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--purple-light);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .effect-icon svg {
            width: 18px;
            height: 18px;
            color: var(--purple);
        }

        .effect-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .effect-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Navigation */
        .nav-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom));
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
        }

        .nav-btn {
            flex: 1;
            padding: 16px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
        }

        .nav-btn svg {
            width: 18px;
            height: 18px;
        }

        .nav-btn.secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .nav-btn.primary {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 16px rgba(218, 119, 86, 0.3);
        }

        .nav-btn.primary:active {
            transform: scale(0.98);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Result Screen */
        .result-screen {
            padding: 24px;
            padding-bottom: 100px;
        }

        .result-card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 28px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .result-icon {
            width: 80px;
            height: 80px;
            background: var(--success-light);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .result-icon svg {
            width: 40px;
            height: 40px;
            color: var(--success);
        }

        .result-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .result-subtitle {
            font-size: 15px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .result-stats {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--purple);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .summary-section {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        .summary-header {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .summary-item {
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 14px;
            margin-bottom: 12px;
        }

        .summary-item:last-child {
            margin-bottom: 0;
        }

        .summary-transform {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .summary-old {
            flex: 1;
            font-size: 13px;
            color: var(--old-phrase);
            text-decoration: line-through;
        }

        .summary-arrow {
            color: var(--purple);
            flex-shrink: 0;
        }

        .summary-arrow svg {
            width: 20px;
            height: 20px;
        }

        .summary-new {
            flex: 1;
            font-size: 14px;
            font-weight: 600;
            color: var(--new-phrase);
        }

        .summary-reps {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .summary-reps svg {
            width: 14px;
            height: 14px;
            color: var(--success);
        }

        .tip-card {
            background: var(--purple-light);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .tip-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .tip-header svg {
            width: 20px;
            height: 20px;
            color: var(--purple);
        }

        .tip-header span {
            font-size: 14px;
            font-weight: 700;
            color: var(--purple);
        }

        .tip-text {
            font-size: 14px;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .action-btn {
            flex: 1;
            padding: 16px;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.2s;
            border: none;
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .action-btn svg {
            width: 18px;
            height: 18px;
        }

        .action-btn.primary {
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 16px rgba(218, 119, 86, 0.3);
        }

        .action-btn.secondary {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.4s ease forwards;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pulse {
            animation: pulse 0.3s ease;
        }

        @keyframes celebrate {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .celebrate {
            animation: celebrate 0.5s ease;
        }

        /* Animación de click en botón */
        @keyframes buttonPop {
            0% { transform: scale(1); }
            30% { transform: scale(0.95); }
            60% { transform: scale(1.08); }
            100% { transform: scale(1); }
        }

        .button-pop {
            animation: buttonPop 0.4s ease;
        }

        /* Toast de feedback */
        .rep-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            background: var(--purple);
            color: white;
            padding: 20px 32px;
            border-radius: 20px;
            font-size: 24px;
            font-weight: 700;
            opacity: 0;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(139, 92, 246, 0.4);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .rep-toast.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .rep-toast.completed {
            background: var(--success);
            box-shadow: 0 10px 40px rgba(44, 165, 141, 0.4);
        }

        /* Ripple effect */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0);
            animation: rippleEffect 0.6s ease-out;
            pointer-events: none;
        }

        @keyframes rippleEffect {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        .speak-btn {
            position: relative;
            overflow: hidden;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <button class="back-btn" onclick="handleBack()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M15 18l-6-6 6-6"/>
            </svg>
            <span>Volver</span>
        </button>
        <span class="header-title">Re-etiquetado</span>
        <div class="header-spacer"></div>
    </header>

    <!-- Start Screen -->
    <div class="screen active" id="startScreen">
        <div class="start-screen">
            <div class="start-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
            </div>
            <h1 class="start-title">Re-etiquetado</h1>
            <p class="start-description">
                Practica transformar tu lenguaje diciendo las nuevas frases EN VOZ ALTA. Repetir activa las redes neuronales del cambio.
            </p>

            <div class="mechanism-box">
                <div class="mechanism-flow">
                    <span class="mechanism-step">Palabra</span>
                    <span class="mechanism-arrow">→</span>
                    <span class="mechanism-step">Emoción</span>
                    <span class="mechanism-arrow">→</span>
                    <span class="mechanism-step">Biología</span>
                </div>
            </div>

            <button class="start-btn" onclick="showModeSelection()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
                Comenzar Práctica
            </button>
        </div>
    </div>

    <!-- Mode Selection Screen -->
    <div class="screen" id="modeScreen">
        <div class="mode-screen">
            <div class="mode-header">
                <h2>¿Cómo quieres practicar?</h2>
                <p>Elige el modo que prefieras</p>
            </div>

            <div class="mode-cards">
                <button class="mode-card" onclick="startPredefined()">
                    <div class="mode-card-icon predefined">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>
                        </svg>
                    </div>
                    <h3>Frases Predefinidas</h3>
                    <p>13 transformaciones organizadas por categoría: Estado, Capacidad, Identidad, Situación y Obligación.</p>
                    <span class="mode-badge">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Listo para usar
                    </span>
                </button>

                <button class="mode-card" onclick="showCustomScreen()">
                    <div class="mode-card-icon custom">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
                            <path d="M19 3v4"/>
                            <path d="M21 5h-4"/>
                        </svg>
                    </div>
                    <h3>Crear Mi Transformación</h3>
                    <p>Escribe tu propia frase limitante y la IA generará una transformación personalizada para ti.</p>
                    <span class="mode-badge ai">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
                        </svg>
                        Con IA · Requiere login
                    </span>
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Transformation Screen -->
    <div class="screen" id="customScreen">
        <div class="custom-screen">
            <div class="custom-header">
                <h2>Crea tu Transformación</h2>
                <p>Escribe una frase limitante que uses frecuentemente</p>
            </div>

            <div class="custom-form" id="customForm">
                <div class="form-group">
                    <label for="customPhrase">Tu frase limitante:</label>
                    <textarea id="customPhrase" placeholder='Ej: "Nunca voy a poder hacerlo bien"'></textarea>
                </div>

                <div class="rate-limit-info" id="rateLimitInfo">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 6v6l4 2"/>
                    </svg>
                    <span id="rateLimitText">Cargando...</span>
                </div>

                <div class="error-message hidden" id="errorMessage">
                    <p id="errorText"></p>
                </div>

                <button class="generate-btn" id="generateBtn" onclick="generateCustom()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
                        <path d="M19 3v4"/>
                        <path d="M21 5h-4"/>
                    </svg>
                    Generar Transformación
                </button>
            </div>

            <div class="loading-state hidden" id="loadingState">
                <div class="loading-spinner"></div>
                <p>Generando tu transformación...</p>
            </div>

            <div class="login-prompt hidden" id="loginPrompt">
                <p>Necesitas iniciar sesión para usar la generación con IA</p>
                <a href="/login" class="login-btn">
                    Iniciar Sesión
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </a>
            </div>
        </div>
    </div>

    <!-- Practice Screen -->
    <div class="screen" id="practiceScreen">
        <div class="practice-screen">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>

            <div class="practice-content" id="practiceContent">
                <!-- Dynamic content -->
            </div>

            <div class="nav-buttons">
                <button class="nav-btn secondary" id="prevBtn" onclick="prevTransform()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M15 18l-6-6 6-6"/>
                    </svg>
                    Anterior
                </button>
                <button class="nav-btn primary" id="nextBtn" onclick="nextTransform()">
                    Siguiente
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Result Screen -->
    <div class="screen" id="resultScreen">
        <div class="result-screen" id="resultContent">
            <!-- Dynamic content -->
        </div>
    </div>

    <!-- Toast de feedback -->
    <div class="rep-toast" id="repToast"></div>

    <script>
        // Expanded transformations - 13 phrases organized by category
        const allTransformations = [
            // Estados Emocionales (4)
            {
                id: 1,
                category: 'Estado',
                old: 'Estoy estresado',
                new: 'Mi cuerpo está activado para esto',
                effect: 'Interpretas la activación como preparación, no amenaza. Tu cortisol se estabiliza.',
                requiredReps: 3
            },
            {
                id: 2,
                category: 'Estado',
                old: 'Soy ansioso',
                new: 'Practico ansiedad y puedo practicar calma',
                effect: 'De identidad fija a comportamiento modificable. Abre la puerta a la neuroplasticidad.',
                requiredReps: 3
            },
            {
                id: 3,
                category: 'Estado',
                old: 'Tengo miedo',
                new: 'Mi sistema está alertándome',
                effect: 'Reconoces la función protectora del miedo en lugar de rechazarlo.',
                requiredReps: 3
            },
            {
                id: 4,
                category: 'Estado',
                old: 'Me siento abrumado',
                new: 'Tengo muchas cosas importantes',
                effect: 'Reencuadras la sobrecarga como abundancia de prioridades.',
                requiredReps: 3
            },
            // Capacidad (4)
            {
                id: 5,
                category: 'Capacidad',
                old: 'No puedo',
                new: 'Todavía no encontré cómo',
                effect: 'Temporal, abre posibilidades. Tu cerebro cambia a modo búsqueda activa.',
                requiredReps: 3
            },
            {
                id: 6,
                category: 'Capacidad',
                old: 'Esto es imposible',
                new: 'Esto es nuevo. Necesito aprender el proceso',
                effect: 'De bloqueo permanente a curva de aprendizaje navegable.',
                requiredReps: 3
            },
            {
                id: 7,
                category: 'Capacidad',
                old: 'Siempre me pasa lo mismo',
                new: 'He notado este patrón antes',
                effect: 'De victimización a observación consciente del patrón.',
                requiredReps: 3
            },
            {
                id: 8,
                category: 'Capacidad',
                old: 'Es un problema',
                new: 'Es un desafío nuevo',
                effect: 'De amenaza sin solución a situación navegable.',
                requiredReps: 3
            },
            // Identidad (3)
            {
                id: 9,
                category: 'Identidad',
                old: 'Soy un fracaso',
                new: 'Obtuve un resultado diferente. ¿Qué aprendí?',
                effect: 'De identidad global negativa a evento específico con aprendizaje.',
                requiredReps: 3
            },
            {
                id: 10,
                category: 'Identidad',
                old: 'Soy depresivo',
                new: 'Experimento depresión',
                effect: 'Separa la experiencia temporal de tu identidad permanente.',
                requiredReps: 3
            },
            {
                id: 11,
                category: 'Identidad',
                old: 'Tengo un problema',
                new: 'Tengo un desafío',
                effect: 'Cambia la carga emocional y activa recursos internos.',
                requiredReps: 3
            },
            // Obligación (2)
            {
                id: 12,
                category: 'Obligación',
                old: 'Tengo que',
                new: 'Elijo',
                effect: 'De víctima a protagonista. Activa tu corteza prefrontal.',
                requiredReps: 3
            },
            {
                id: 13,
                category: 'Obligación',
                old: 'Debería',
                new: 'Podría considerar',
                effect: 'Reduce la presión interna y abre opciones sin juicio.',
                requiredReps: 3
            }
        ];

        // State
        let transformations = [];
        let currentIndex = 0;
        let practiceData = {};
        let totalReps = 0;
        let isCustomMode = false;
        let userSession = null;

        // Check user session
        async function checkSession() {
            try {
                const response = await fetch('/api/auth/session');
                const data = await response.json();
                userSession = data?.user ? data : null;
            } catch (e) {
                userSession = null;
            }
        }

        // Initialize
        checkSession();

        // Functions
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showModeSelection() {
            showScreen('modeScreen');
        }

        function startPredefined() {
            transformations = [...allTransformations];
            isCustomMode = false;
            currentIndex = 0;
            initPracticeData();
            showScreen('practiceScreen');
            renderTransform();
        }

        async function showCustomScreen() {
            await checkSession();

            if (!userSession) {
                showScreen('customScreen');
                document.getElementById('customForm').classList.add('hidden');
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('loginPrompt').classList.remove('hidden');
                return;
            }

            showScreen('customScreen');
            document.getElementById('customForm').classList.remove('hidden');
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('loginPrompt').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('customPhrase').value = '';

            // Update rate limit info
            document.getElementById('rateLimitText').textContent = '5 transformaciones disponibles por día';
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            document.getElementById('errorText').textContent = message;
            errorEl.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorMessage').classList.add('hidden');
        }

        function showLoading(show) {
            document.getElementById('customForm').classList.toggle('hidden', show);
            document.getElementById('loadingState').classList.toggle('hidden', !show);
        }

        async function generateCustom() {
            const phrase = document.getElementById('customPhrase').value.trim();

            if (!phrase) {
                showError('Por favor escribe una frase');
                return;
            }

            if (phrase.length > 200) {
                showError('La frase es muy larga. Máximo 200 caracteres.');
                return;
            }

            hideError();
            showLoading(true);

            try {
                const response = await fetch('/api/reetiquetado/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phrase })
                });

                const data = await response.json();

                if (!response.ok) {
                    if (response.status === 401) {
                        showLoading(false);
                        document.getElementById('customForm').classList.add('hidden');
                        document.getElementById('loginPrompt').classList.remove('hidden');
                        return;
                    }
                    throw new Error(data.error || 'Error al generar');
                }

                // Update rate limit display
                if (data.rateLimit) {
                    document.getElementById('rateLimitText').textContent =
                        `Te quedan ${data.rateLimit.remaining} transformaciones hoy`;
                }

                // Start practice with the custom transformation
                transformations = [data.transformation];
                isCustomMode = true;
                currentIndex = 0;
                initPracticeData();
                showScreen('practiceScreen');
                renderTransform();

            } catch (error) {
                showLoading(false);
                showError(error.message || 'Error al generar. Intenta de nuevo.');
            }
        }

        function initPracticeData() {
            practiceData = {};
            transformations.forEach(t => {
                practiceData[t.id] = { reps: 0, completed: false };
            });
            totalReps = 0;
        }

        function renderTransform() {
            const t = transformations[currentIndex];
            const data = practiceData[t.id];
            const progress = ((currentIndex + 1) / transformations.length) * 100;

            document.getElementById('progressFill').style.width = `${progress}%`;

            const container = document.getElementById('practiceContent');
            container.innerHTML = `
                <div class="practice-header fade-in">
                    <p class="practice-step">${t.category} · ${currentIndex + 1} de ${transformations.length}</p>
                    <h2 class="practice-title">Di la nueva frase en voz alta</h2>
                </div>

                <div class="transform-card fade-in" style="animation-delay: 0.1s">
                    <div class="transform-visual">
                        <div class="phrase-container">
                            <div class="phrase-box old">
                                <p class="phrase-label">En lugar de decir</p>
                                <p class="phrase-text">"${t.old}"</p>
                            </div>

                            <div class="transform-arrow">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"/>
                                    <polyline points="19 12 12 19 5 12"/>
                                </svg>
                            </div>

                            <div class="phrase-box new" id="newPhraseBox">
                                <p class="phrase-label">Voy a decir</p>
                                <p class="phrase-text" id="newPhraseText">"${t.new}"</p>
                            </div>
                        </div>
                    </div>

                    <div class="practice-action">
                        <p class="action-instruction">Presiona cada vez que digas la frase</p>
                        <p class="action-sub">Decirlo en voz alta activa las redes neuronales del cambio</p>

                        <button class="speak-btn ${data.completed ? 'completed' : ''}" id="speakBtn" onclick="countRep(event)">
                            ${data.completed ? `
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                    <polyline points="22 4 12 14.01 9 11.01"/>
                                </svg>
                                ¡Completado!
                            ` : `
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                    <line x1="12" x2="12" y1="19" y2="22"/>
                                </svg>
                                ¡Lo dije!
                            `}
                        </button>

                        <div class="speak-counter" id="speakCounter">
                            ${[1, 2, 3].map(i => `
                                <div class="counter-dot ${data.reps >= i ? 'completed' : ''} ${data.reps === i - 1 ? 'active' : ''}"></div>
                            `).join('')}
                        </div>

                        <div class="speak-feedback ${data.completed ? 'show' : ''}" id="speakFeedback">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            <span>¡3 repeticiones completadas!</span>
                        </div>
                    </div>
                </div>

                <div class="effect-card fade-in" style="animation-delay: 0.2s">
                    <div class="effect-header">
                        <div class="effect-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                            </svg>
                        </div>
                        <span class="effect-title">Efecto Neurobiológico</span>
                    </div>
                    <p class="effect-text">${t.effect}</p>
                </div>
            `;

            updateNavButtons();
        }

        // Mensajes de ánimo por repetición
        const encourageMessages = [
            '1 de 3',
            '2 de 3',
            '3 de 3'
        ];

        // Sonido de feedback (usando Web Audio API)
        function playFeedbackSound(isComplete = false) {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.type = 'sine';

                if (isComplete) {
                    // Sonido de completado (tono ascendente)
                    oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
                    oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1); // E5
                    oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime + 0.2); // G5
                    gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.4);
                } else {
                    // Sonido simple de click
                    oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                    gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.08);
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.08);
                }
            } catch (e) {
                // Audio no disponible, ignorar
            }
        }

        // Mostrar toast de feedback
        function showRepToast(message, isComplete = false) {
            const toast = document.getElementById('repToast');
            toast.textContent = message;
            toast.classList.remove('completed');
            if (isComplete) {
                toast.classList.add('completed');
            }
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, isComplete ? 1200 : 800);
        }

        // Crear efecto ripple en botón
        function createRipple(event, button) {
            const ripple = document.createElement('span');
            ripple.classList.add('ripple');

            const rect = button.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);

            ripple.style.width = ripple.style.height = `${size}px`;
            ripple.style.left = `${event.clientX - rect.left - size / 2}px`;
            ripple.style.top = `${event.clientY - rect.top - size / 2}px`;

            button.appendChild(ripple);

            setTimeout(() => ripple.remove(), 600);
        }

        function countRep(event) {
            const t = transformations[currentIndex];
            const data = practiceData[t.id];

            if (data.completed) return;

            data.reps++;
            totalReps++;

            const speakBtn = document.getElementById('speakBtn');

            // Efecto ripple
            if (event) {
                createRipple(event, speakBtn);
            }

            // Vibración
            if (navigator.vibrate) {
                navigator.vibrate(data.reps >= t.requiredReps ? [50, 50, 100] : 50);
            }

            // Animación del botón
            speakBtn.classList.add('button-pop');
            setTimeout(() => speakBtn.classList.remove('button-pop'), 400);

            // Animación de la frase
            const newPhraseBox = document.getElementById('newPhraseBox');
            newPhraseBox.classList.add('pulse');
            setTimeout(() => newPhraseBox.classList.remove('pulse'), 300);

            // Actualizar dots
            const dots = document.querySelectorAll('.counter-dot');
            dots.forEach((dot, i) => {
                dot.classList.remove('active', 'completed');
                if (data.reps > i) {
                    dot.classList.add('completed');
                } else if (data.reps === i) {
                    dot.classList.add('active');
                }
            });

            // Mostrar toast con mensaje de ánimo
            const message = encourageMessages[Math.min(data.reps - 1, encourageMessages.length - 1)];
            const isComplete = data.reps >= t.requiredReps;
            showRepToast(isComplete ? 'Completado' : message, isComplete);

            // Sonido
            playFeedbackSound(isComplete);

            if (isComplete) {
                data.completed = true;

                speakBtn.classList.add('completed', 'celebrate');
                speakBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    ¡Completado!
                `;

                document.getElementById('speakFeedback').classList.add('show');
            }
        }

        function updateNavButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.style.visibility = currentIndex === 0 ? 'hidden' : 'visible';

            if (currentIndex === transformations.length - 1) {
                nextBtn.innerHTML = `
                    Ver Resumen
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                `;
            } else {
                nextBtn.innerHTML = `
                    Siguiente
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                `;
            }
        }

        function prevTransform() {
            if (currentIndex > 0) {
                currentIndex--;
                renderTransform();
            }
        }

        function nextTransform() {
            if (currentIndex < transformations.length - 1) {
                currentIndex++;
                renderTransform();
            } else {
                showResult();
            }
        }

        function showResult() {
            showScreen('resultScreen');
            renderResult();
        }

        function renderResult() {
            const container = document.getElementById('resultContent');
            const completedCount = Object.values(practiceData).filter(d => d.completed).length;

            container.innerHTML = `
                <div class="result-card fade-in">
                    <div class="result-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                    </div>
                    <h2 class="result-title">¡Práctica Completada!</h2>
                    <p class="result-subtitle">Has practicado transformar tu lenguaje en voz alta.</p>

                    <div class="result-stats">
                        <div class="stat-item">
                            <div class="stat-value">${totalReps}</div>
                            <div class="stat-label">Repeticiones</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${completedCount}/${transformations.length}</div>
                            <div class="stat-label">Completadas</div>
                        </div>
                    </div>
                </div>

                <div class="tip-card fade-in" style="animation-delay: 0.1s">
                    <div class="tip-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 16v-4"/>
                            <path d="M12 8h.01"/>
                        </svg>
                        <span>Para consolidar el cambio</span>
                    </div>
                    <p class="tip-text">
                        Usa estas frases durante el día cuando notes el patrón antiguo. Cada repetición fortalece las nuevas conexiones neuronales.
                    </p>
                </div>

                <div class="summary-section fade-in" style="animation-delay: 0.2s">
                    <p class="summary-header">Tus Re-etiquetados</p>
                    ${transformations.map(t => {
                        const data = practiceData[t.id];
                        return `
                            <div class="summary-item">
                                <div class="summary-transform">
                                    <span class="summary-old">"${t.old}"</span>
                                    <div class="summary-arrow">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M5 12h14"/>
                                            <path d="M12 5l7 7-7 7"/>
                                        </svg>
                                    </div>
                                    <span class="summary-new">"${t.new}"</span>
                                </div>
                                <div class="summary-reps">
                                    ${data.completed ? `
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polyline points="20 6 9 17 4 12"/>
                                        </svg>
                                        ${data.reps} repeticiones
                                    ` : `${data.reps}/${t.requiredReps} repeticiones`}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>

                <div class="action-buttons fade-in" style="animation-delay: 0.3s">
                    <button class="action-btn secondary" onclick="resetPractice()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                            <path d="M3 3v5h5"/>
                        </svg>
                        Practicar Más
                    </button>
                    <button class="action-btn primary" onclick="saveAndClose()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        Finalizar
                    </button>
                </div>
            `;
        }

        function resetPractice() {
            if (isCustomMode) {
                showCustomScreen();
            } else {
                currentIndex = 0;
                initPracticeData();
                showScreen('practiceScreen');
                renderTransform();
            }
        }

        function saveAndClose() {
            const session = {
                practiceData,
                totalReps,
                completedCount: Object.values(practiceData).filter(d => d.completed).length,
                timestamp: new Date().toISOString(),
                isCustom: isCustomMode
            };

            let history = JSON.parse(localStorage.getItem('reetiquetado_history') || '[]');
            history.unshift(session);
            if (history.length > 20) history = history.slice(0, 20);
            localStorage.setItem('reetiquetado_history', JSON.stringify(history));

            goToApps();
        }

        function handleBack() {
            const activeScreen = document.querySelector('.screen.active').id;

            if (activeScreen === 'practiceScreen') {
                if (currentIndex === 0) {
                    showScreen('modeScreen');
                } else {
                    prevTransform();
                }
            } else if (activeScreen === 'resultScreen') {
                showScreen('modeScreen');
            } else if (activeScreen === 'modeScreen') {
                showScreen('startScreen');
            } else if (activeScreen === 'customScreen') {
                showScreen('modeScreen');
            } else if (activeScreen === 'startScreen') {
                goToApps();
            }
        }

        function goToApps() {
            window.location.href = '/apps';
        }

        console.log('Re-etiquetado App v3.1 - Con feedback mejorado');
    </script>
</body>
</html>
