<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Detector de Estados</title>
    <style>
        :root {
            --bg-primary: #FAF9F7;
            --bg-secondary: #F5F4F0;
            --bg-card: #FFFFFF;
            --text-primary: #1A1915;
            --text-secondary: #706F6C;
            --text-muted: #9B9A97;
            --border-color: #E5E4E0;
            --accent: #DA7756;
            --accent-light: rgba(218, 119, 86, 0.1);
            --success: #2ca58d;
            --success-light: rgba(44, 165, 141, 0.15);
            --ventral: #2ca58d;
            --ventral-light: rgba(44, 165, 141, 0.15);
            --simpatico: #E8A54B;
            --simpatico-light: rgba(232, 165, 75, 0.15);
            --dorsal: #7B8794;
            --dorsal-light: rgba(123, 135, 148, 0.15);
            --xp-gold: #F59E0B;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #121212;
                --bg-secondary: #1E1E1E;
                --bg-card: #252525;
                --text-primary: #ECECEC;
                --text-secondary: #B4B4B4;
                --text-muted: #808080;
                --border-color: #333333;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: none;
            border: none;
            color: var(--accent);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            padding: 8px 0;
        }

        .back-btn svg { width: 20px; height: 20px; }

        .header-stats {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stat-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: var(--bg-secondary);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .stat-badge.xp {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05));
            color: var(--xp-gold);
        }

        .stat-badge svg { width: 16px; height: 16px; }

        .sound-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background: var(--bg-secondary);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .sound-toggle:hover {
            background: var(--border-color);
        }

        .sound-toggle.muted {
            color: var(--text-muted);
        }

        .sound-toggle svg {
            width: 18px;
            height: 18px;
        }

        .hidden { display: none; }

        /* Progress Bar */
        .progress-bar {
            height: 4px;
            background: var(--bg-secondary);
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s ease;
        }

        /* Screens */
        .screen {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow-y: auto;
        }

        .screen.active { display: flex; }

        /* Start Screen */
        .start-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            text-align: center;
        }

        .start-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--accent), #B85A3A);
            border-radius: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(218, 119, 86, 0.3);
        }

        .start-icon svg {
            width: 48px;
            height: 48px;
            color: white;
        }

        .start-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .start-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
            max-width: 300px;
            line-height: 1.5;
        }

        .start-stats {
            display: flex;
            gap: 24px;
            margin-bottom: 40px;
        }

        .start-stat {
            text-align: center;
        }

        .start-stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--accent);
        }

        .start-stat-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .start-btn {
            padding: 18px 56px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(218, 119, 86, 0.3);
            transition: transform 0.2s;
        }

        .start-btn:active { transform: scale(0.98); }

        /* Scenario Screen */
        .scenario-screen {
            padding: 20px;
            padding-bottom: 100px;
        }

        .scenario-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .scenario-icon {
            width: 56px;
            height: 56px;
            background: var(--accent-light);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .scenario-icon svg {
            width: 28px;
            height: 28px;
            color: var(--accent);
        }

        .scenario-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .scenario-context {
            font-size: 15px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .question-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .question-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .question-number {
            width: 32px;
            height: 32px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        .question-text {
            font-size: 16px;
            font-weight: 600;
            flex: 1;
        }

        /* Body Map */
        .body-map-container {
            display: flex;
            justify-content: center;
            margin-bottom: 16px;
        }

        .body-map {
            position: relative;
            width: 140px;
            height: 280px;
        }

        .body-outline {
            width: 100%;
            height: 100%;
        }

        .body-zone {
            position: absolute;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .body-zone:hover {
            background: var(--accent-light);
        }

        .body-zone.selected {
            background: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        .body-zone.selected::after {
            content: '‚úì';
            color: white;
            font-size: 16px;
            font-weight: bold;
        }

        .zone-head { top: 0; left: 50%; transform: translateX(-50%); width: 50px; height: 50px; border-radius: 50%; }
        .zone-chest { top: 60px; left: 50%; transform: translateX(-50%); width: 70px; height: 50px; }
        .zone-stomach { top: 115px; left: 50%; transform: translateX(-50%); width: 60px; height: 45px; }
        .zone-shoulders { top: 55px; left: 50%; transform: translateX(-50%); width: 100px; height: 30px; border-radius: 20px; }
        .zone-hands { top: 170px; left: 50%; transform: translateX(-50%); width: 110px; height: 35px; border-radius: 20px; }
        .zone-legs { top: 200px; left: 50%; transform: translateX(-50%); width: 80px; height: 70px; }

        .body-labels {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .body-label {
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .body-label.selected {
            background: var(--accent-light);
            border-color: var(--accent);
            color: var(--accent);
            font-weight: 500;
        }

        /* Options Grid */
        .options-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-btn {
            padding: 16px;
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: 14px;
            font-size: 15px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .option-btn:hover {
            border-color: var(--border-color);
        }

        .option-btn.selected {
            background: var(--accent-light);
            border-color: var(--accent);
        }

        .option-btn.correct {
            background: var(--success-light);
            border-color: var(--success);
        }

        .option-btn.incorrect {
            background: rgba(239, 68, 68, 0.1);
            border-color: #EF4444;
        }

        .option-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: var(--bg-secondary);
        }

        .option-icon svg {
            width: 20px;
            height: 20px;
            color: var(--text-secondary);
        }

        .option-btn.selected .option-icon {
            background: var(--accent);
        }

        .option-btn.selected .option-icon svg {
            color: white;
        }

        .option-btn.correct .option-icon {
            background: var(--success);
        }

        .option-btn.correct .option-icon svg {
            color: white;
        }

        .option-content {
            flex: 1;
        }

        .option-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .option-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* State Cards */
        .state-option {
            padding: 16px;
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .state-option.ventral {
            --state-color: var(--ventral);
            --state-bg: var(--ventral-light);
        }
        .state-option.simpatico {
            --state-color: var(--simpatico);
            --state-bg: var(--simpatico-light);
        }
        .state-option.dorsal {
            --state-color: var(--dorsal);
            --state-bg: var(--dorsal-light);
        }

        .state-option.selected {
            background: var(--state-bg);
            border-color: var(--state-color);
        }

        .state-option.correct {
            background: var(--success-light);
            border-color: var(--success);
        }

        .state-indicator {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 auto 12px;
            background: var(--state-color);
            opacity: 0.3;
        }

        .state-option.selected .state-indicator,
        .state-option.correct .state-indicator {
            opacity: 1;
        }

        .state-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .state-desc {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Technique Practice */
        .technique-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 24px;
            text-align: center;
        }

        .technique-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: var(--success-light);
            color: var(--success);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .technique-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .technique-desc {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .breathing-visual {
            width: 160px;
            height: 160px;
            margin: 0 auto 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--success), var(--ventral));
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 40px var(--success-light);
            transform: scale(0.85);
            transition: transform 0.3s ease-out;
        }

        .breathing-text {
            color: white;
            text-align: center;
        }

        .breathing-instruction {
            font-size: 18px;
            font-weight: 600;
        }

        .breathing-count {
            font-size: 42px;
            font-weight: 800;
        }

        .technique-steps {
            text-align: left;
            margin-bottom: 20px;
        }

        .technique-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .technique-step:last-child {
            border-bottom: none;
        }

        .step-number {
            width: 24px;
            height: 24px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .step-text {
            font-size: 14px;
            line-height: 1.5;
        }

        .practice-btn {
            width: 100%;
            padding: 16px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .practice-btn:active { transform: scale(0.98); }

        .practice-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Feedback */
        .feedback-card {
            padding: 16px;
            border-radius: 14px;
            margin-top: 16px;
            display: none;
        }

        .feedback-card.show { display: block; }

        .feedback-card.correct {
            background: var(--success-light);
            border: 1px solid var(--success);
        }

        .feedback-card.incorrect {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #EF4444;
        }

        .feedback-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .feedback-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .feedback-icon.correct-icon {
            background: var(--success);
            position: relative;
        }

        .feedback-icon.correct-icon::after {
            content: '';
            position: absolute;
            left: 6px;
            top: 4px;
            width: 5px;
            height: 9px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .feedback-icon.info-icon {
            background: var(--simpatico);
            position: relative;
        }

        .feedback-icon.info-icon::after {
            content: 'i';
            color: white;
            font-size: 14px;
            font-weight: 700;
            font-style: italic;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        .feedback-title {
            font-size: 15px;
            font-weight: 600;
        }

        .feedback-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .xp-popup {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-top: 12px;
            font-size: 18px;
            font-weight: 700;
            color: var(--xp-gold);
        }

        /* Result Screen */
        .result-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            text-align: center;
        }

        .result-icon {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .result-icon svg {
            width: 48px;
            height: 48px;
            color: white;
        }

        .result-icon.great {
            background: linear-gradient(135deg, var(--success), var(--ventral));
            box-shadow: 0 8px 32px var(--success-light);
        }

        .result-icon.good {
            background: linear-gradient(135deg, var(--simpatico), #FFD93D);
            box-shadow: 0 8px 32px var(--simpatico-light);
        }

        .result-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .result-message {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
            max-width: 300px;
            line-height: 1.5;
        }

        .result-stats {
            display: flex;
            gap: 32px;
            margin-bottom: 32px;
        }

        .result-stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent);
        }

        .result-stat-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .result-xp {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 16px 32px;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05));
            border: 2px solid var(--xp-gold);
            border-radius: 16px;
            margin-bottom: 32px;
        }

        .result-xp-value {
            font-size: 32px;
            font-weight: 800;
            color: var(--xp-gold);
        }

        .result-xp-label {
            font-size: 14px;
            color: var(--xp-gold);
        }

        .result-btn {
            padding: 16px 48px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 8px;
        }

        .result-btn.secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .result-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            max-width: 280px;
        }

        /* History Screen */
        .history-screen {
            flex: 1;
            padding: 20px;
            padding-bottom: 100px;
            overflow-y: auto;
        }

        .history-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .history-header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .history-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .history-round-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .history-round-number {
            width: 28px;
            height: 28px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .history-scenario-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
            line-height: 1.3;
        }

        .history-item {
            margin-bottom: 12px;
        }

        .history-item:last-child {
            margin-bottom: 0;
        }

        .history-item-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .history-item-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .history-answer {
            font-size: 14px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            flex: 1;
        }

        .history-answer.correct {
            background: var(--success-light);
            border: 1px solid var(--success);
        }

        .history-answer.incorrect {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #EF4444;
        }

        .history-correct-answer {
            font-size: 13px;
            color: var(--text-secondary);
            padding: 6px 10px;
            background: var(--success-light);
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .history-correct-answer svg {
            width: 12px;
            height: 12px;
            color: var(--success);
        }

        .history-explanation {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 6px;
            padding-left: 12px;
            border-left: 2px solid var(--border-color);
            line-height: 1.4;
        }

        .history-result-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .history-result-badge.success {
            background: var(--success-light);
            color: var(--success);
        }

        .history-result-badge.partial {
            background: var(--simpatico-light);
            color: var(--simpatico);
        }

        .history-back-btn {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom));
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
        }

        .history-back-btn button {
            width: 100%;
            padding: 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Navigation */
        .nav-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom));
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
        }

        .nav-btn {
            flex: 1;
            padding: 16px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .nav-btn.primary {
            background: var(--accent);
            border: none;
            color: white;
        }

        .nav-btn.primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-btn svg { width: 20px; height: 20px; }
    </style>
</head>
<body>
    <header class="header">
        <button class="back-btn" onclick="goBack()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Volver
        </button>
        <div class="header-stats">
            <button class="sound-toggle" id="soundToggle" onclick="toggleSound()" title="Sonido">
                <svg id="soundOnIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
                </svg>
                <svg id="soundOffIcon" class="hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                    <line x1="23" y1="9" x2="17" y2="15"/>
                    <line x1="17" y1="9" x2="23" y2="15"/>
                </svg>
            </button>
            <div class="stat-badge">
                <span id="roundDisplay">1/5</span>
            </div>
            <div class="stat-badge xp">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                </svg>
                <span id="xpDisplay">0</span>
            </div>
        </div>
    </header>

    <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>

    <!-- Start Screen -->
    <div class="screen active" id="startScreen">
        <div class="start-screen">
            <div class="start-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 16v-4M12 8h.01"/>
                </svg>
            </div>
            <h1 class="start-title">Detector de Estados</h1>
            <p class="start-subtitle">
                Entrena tu capacidad de reconocer se√±ales corporales y elegir la t√©cnica correcta
            </p>
            <div class="start-stats">
                <div class="start-stat">
                    <div class="start-stat-value" id="totalRounds">0</div>
                    <div class="start-stat-label">Rondas</div>
                </div>
                <div class="start-stat">
                    <div class="start-stat-value" id="accuracy">0%</div>
                    <div class="start-stat-label">Precisi√≥n</div>
                </div>
                <div class="start-stat">
                    <div class="start-stat-value" id="totalXP">0</div>
                    <div class="start-stat-label">XP Total</div>
                </div>
            </div>
            <button class="start-btn" onclick="startGame()">Comenzar</button>
        </div>
    </div>

    <!-- Scenario Screen -->
    <div class="screen" id="scenarioScreen">
        <div class="scenario-screen">
            <!-- Scenario Description -->
            <div class="scenario-card" id="scenarioCard">
                <div class="scenario-icon" id="scenarioIcon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 16v-4M12 8h.01"/>
                    </svg>
                </div>
                <h2 class="scenario-title" id="scenarioTitle">Cargando...</h2>
                <p class="scenario-context" id="scenarioContext">...</p>
            </div>

            <!-- Question Cards (shown one at a time) -->
            <div id="questionContainer"></div>
        </div>
        <div class="nav-buttons">
            <button class="nav-btn primary" id="nextBtn" onclick="handleNext()" disabled>
                Continuar
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Result Screen -->
    <div class="screen" id="resultScreen">
        <div class="result-screen">
            <div class="result-icon great" id="resultIcon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M20 6L9 17l-5-5"/>
                </svg>
            </div>
            <h2 class="result-title" id="resultTitle">¬°Excelente!</h2>
            <p class="result-message" id="resultMessage">
                Tu capacidad de detectar estados ha mejorado.
            </p>
            <div class="result-stats">
                <div class="result-stat">
                    <div class="result-stat-value" id="correctAnswers">0</div>
                    <div class="result-stat-label">Correctas</div>
                </div>
                <div class="result-stat">
                    <div class="result-stat-value" id="sessionAccuracy">0%</div>
                    <div class="result-stat-label">Precisi√≥n</div>
                </div>
            </div>
            <div class="result-xp">
                <div>
                    <div class="result-xp-value" id="earnedXP">+0</div>
                    <div class="result-xp-label">XP Ganados</div>
                </div>
            </div>
            <div class="result-buttons">
                <button class="result-btn" onclick="startGame()">Jugar de Nuevo</button>
                <button class="result-btn secondary" onclick="showHistory()">Ver Respuestas</button>
                <button class="result-btn secondary" onclick="showStart()">Men√∫</button>
            </div>
        </div>
    </div>

    <!-- History Screen -->
    <div class="screen" id="historyScreen">
        <div class="history-screen">
            <div class="history-header">
                <h2>üìã Resumen de Respuestas</h2>
            </div>
            <div id="historyContent"></div>
        </div>
        <div class="history-back-btn">
            <button onclick="showScreen('resultScreen')">Volver a Resultados</button>
        </div>
    </div>

    <script>
        // Game Data
        const scenarios = [
            {
                id: 1,
                icon: "briefcase",
                title: "Tu jefe te manda un mensaje: \"Tenemos que hablar\"",
                context: "Est√°s en casa descansando y ves la notificaci√≥n. No tienes m√°s contexto sobre qu√© se trata.",
                bodyZones: ["chest", "stomach"],
                sensations: ["Opresi√≥n en pecho", "Nudo en est√≥mago", "Respiraci√≥n corta"],
                correctState: "simpatico",
                stateExplanation: "Tu cuerpo se activa en modo alerta (simp√°tico) ante la incertidumbre y posible amenaza.",
                bestTechnique: "breathing",
                techniqueReason: "La respiraci√≥n 4-7-8 activa el nervio vago y baja la respuesta simp√°tica r√°pidamente."
            },
            {
                id: 2,
                icon: "users",
                title: "Discusi√≥n con tu pareja sobre finanzas",
                context: "Llevan 20 minutos discutiendo el mismo tema. Sientes que no te escucha y t√∫ tampoco puedes escuchar.",
                bodyZones: ["shoulders", "head"],
                sensations: ["Tensi√≥n en hombros", "Calor en cara", "Mand√≠bula apretada"],
                correctState: "simpatico",
                stateExplanation: "Est√°s en modo lucha: el cuerpo se prepara para defenderse, tensando m√∫sculos y aumentando temperatura.",
                bestTechnique: "pause",
                techniqueReason: "Necesitas una pausa para que el c√≥rtex prefrontal vuelva a funcionar. No puedes resolver nada en este estado."
            },
            {
                id: 3,
                icon: "presentation",
                title: "Presentaci√≥n importante en 10 minutos",
                context: "Es tu turno de presentar ante el equipo directivo. Sientes que tu mente est√° en blanco.",
                bodyZones: ["chest", "hands"],
                sensations: ["Coraz√≥n acelerado", "Manos fr√≠as/sudorosas", "Boca seca"],
                correctState: "simpatico",
                stateExplanation: "Activaci√≥n simp√°tica ante el desempe√±o social. Es normal, pero necesita regulaci√≥n.",
                bestTechnique: "grounding",
                techniqueReason: "El anclaje 5-4-3-2-1 te devuelve al presente y reduce la anticipaci√≥n ansiosa."
            },
            {
                id: 4,
                icon: "battery-low",
                title: "Llevas semanas sin energ√≠a para nada",
                context: "Las tareas simples se sienten como monta√±as. Prefieres quedarte en la cama aunque no duermas.",
                bodyZones: ["chest", "legs"],
                sensations: ["Pesadez general", "Sin energ√≠a", "Ganas de desaparecer"],
                correctState: "dorsal",
                stateExplanation: "Estado de colapso dorsal: el sistema se apaga como mecanismo de protecci√≥n ante estr√©s cr√≥nico.",
                bestTechnique: "movement",
                techniqueReason: "Movimiento suave (no intenso) ayuda a salir del colapso dorsal activando gradualmente el sistema."
            },
            {
                id: 5,
                icon: "alert-triangle",
                title: "Casi te atropella un auto al cruzar",
                context: "El auto fren√≥ a cent√≠metros de ti. Ya pas√≥ el peligro pero tu cuerpo sigue reaccionando.",
                bodyZones: ["chest", "legs"],
                sensations: ["Temblor", "Coraz√≥n muy r√°pido", "Piernas d√©biles"],
                correctState: "simpatico",
                stateExplanation: "Respuesta de supervivencia activada. La adrenalina necesita descargarse aunque el peligro pas√≥.",
                bestTechnique: "shake",
                techniqueReason: "Sacudir el cuerpo permite liberar la energ√≠a de supervivencia acumulada, como hacen los animales."
            },
            {
                id: 6,
                icon: "sun",
                title: "Domingo tranquilo leyendo un libro",
                context: "Est√°s en tu sill√≥n favorito, con t√© caliente. No tienes pendientes urgentes.",
                bodyZones: [],
                sensations: ["Respiraci√≥n lenta", "M√∫sculos relajados", "Mente tranquila"],
                correctState: "ventral",
                stateExplanation: "Estado ventral vagal: seguridad, conexi√≥n social, capacidad de descanso y digesti√≥n.",
                bestTechnique: "none",
                techniqueReason: "No necesitas t√©cnica. Este es el estado √≥ptimo. Disfr√∫talo y nota c√≥mo se siente."
            },
            {
                id: 7,
                icon: "phone",
                title: "Recibes una llamada de un n√∫mero desconocido",
                context: "Contestas y es del hospital. Tu padre tuvo un accidente. Est√° estable pero...",
                bodyZones: ["chest", "stomach"],
                sensations: ["Vac√≠o en est√≥mago", "Fr√≠o repentino", "Mente acelerada"],
                correctState: "simpatico",
                stateExplanation: "Shock inicial con activaci√≥n simp√°tica. El cuerpo se prepara para actuar ante la emergencia.",
                bestTechnique: "breathing",
                techniqueReason: "Necesitas regular para poder pensar con claridad y tomar decisiones sobre qu√© hacer."
            },
            {
                id: 8,
                icon: "user-x",
                title: "Tu hijo adolescente te ignora por tercera vez",
                context: "Le pediste que recoja su cuarto. Te mira, sigue en el tel√©fono, y act√∫a como si no existieras.",
                bodyZones: ["chest", "head"],
                sensations: ["Calor subiendo", "Ganas de gritar", "Tensi√≥n en mand√≠bula"],
                correctState: "simpatico",
                stateExplanation: "Modo lucha activado. La sensaci√≥n de ser ignorado activa respuestas defensivas.",
                bestTechnique: "pause",
                techniqueReason: "STOP: da la vuelta, respira, y responde cuando puedas pensar. Reaccionar empeorar√° la situaci√≥n."
            }
        ];

        const techniques = {
            breathing: {
                name: "Respiraci√≥n 4-7-8",
                desc: "Inhala 4s, sost√©n 7s, exhala 8s",
                iconSvg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></svg>',
                steps: [
                    "Inhala por la nariz contando hasta 4",
                    "Sost√©n el aire contando hasta 7",
                    "Exhala por la boca contando hasta 8",
                    "Repite 3-4 ciclos"
                ]
            },
            grounding: {
                name: "Anclaje 5-4-3-2-1",
                desc: "Usa tus sentidos para volver al presente",
                iconSvg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="5" r="3"/><line x1="12" y1="22" x2="12" y2="8"/><path d="M5 12H2a10 10 0 0 0 20 0h-3"/></svg>',
                steps: [
                    "Nombra 5 cosas que puedes VER",
                    "Nombra 4 cosas que puedes TOCAR",
                    "Nombra 3 cosas que puedes O√çR",
                    "Nombra 2 cosas que puedes OLER",
                    "Nombra 1 cosa que puedes SABOREAR"
                ]
            },
            pause: {
                name: "Pausa STOP",
                desc: "Detente antes de reaccionar",
                iconSvg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><rect x="9" y="9" width="6" height="6"/></svg>',
                steps: [
                    "STOP: Detente f√≠sicamente",
                    "TAKE a breath: Respira profundo",
                    "OBSERVE: Observa qu√© sientes",
                    "PROCEED: Procede con conciencia"
                ]
            },
            movement: {
                name: "Movimiento Suave",
                desc: "Activa gradualmente tu cuerpo",
                iconSvg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 4v16"/><path d="M17 4v16"/><path d="M19 4H9.5a4.5 4.5 0 0 0 0 9H13"/></svg>',
                steps: [
                    "Estira los brazos lentamente",
                    "Gira el cuello suavemente",
                    "Camina unos pasos",
                    "Siente c√≥mo vuelve la energ√≠a"
                ]
            },
            shake: {
                name: "Sacudir y Liberar",
                desc: "Descarga la energ√≠a acumulada",
                iconSvg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>',
                steps: [
                    "De pie, sacude las manos vigorosamente",
                    "Sacude los brazos y hombros",
                    "Sacude todo el cuerpo",
                    "Deja que el temblor natural contin√∫e"
                ]
            },
            none: {
                name: "Disfrutar el Momento",
                desc: "Ya est√°s regulado",
                iconSvg: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>',
                steps: [
                    "Nota c√≥mo se siente tu cuerpo relajado",
                    "Aprecia este momento de calma",
                    "Guarda esta sensaci√≥n en tu memoria",
                    "Recuerda: puedes volver aqu√≠"
                ]
            }
        };

        const states = [
            { id: "ventral", name: "Ventral (Calma)", desc: "Seguro, conectado, presente", color: "ventral" },
            { id: "simpatico", name: "Simp√°tico (Alerta)", desc: "Lucha, huida, activaci√≥n", color: "simpatico" },
            { id: "dorsal", name: "Dorsal (Colapso)", desc: "Apagado, sin energ√≠a, desconectado", color: "dorsal" }
        ];

        // Game State
        const gameState = {
            totalXP: 0,
            totalRounds: 0,
            totalCorrect: 0,
            currentRound: 0,
            currentStep: 0, // 0: body, 1: sensation, 2: state, 3: technique, 4: practice
            currentScenario: null,
            sessionXP: 0,
            sessionCorrect: 0,
            roundsPerSession: 5,
            answers: {
                bodyZones: [],
                sensations: [],
                state: null,
                technique: null
            }
        };

        let usedScenarios = [];
        let breathingInterval = null;
        let sessionHistory = []; // Historial de respuestas de la sesi√≥n

        // Audio System - Web Audio API para sonidos de gu√≠a
        let audioContext = null;
        let soundEnabled = true;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // Crear un tono suave con envelope ADSR
        function playTone(frequency, duration, type = 'sine', volume = 0.3) {
            if (!soundEnabled || !audioContext) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = frequency;
            oscillator.type = type;

            const now = audioContext.currentTime;

            // Envelope suave: fade in y fade out
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(volume, now + 0.05); // Attack
            gainNode.gain.linearRampToValueAtTime(volume * 0.7, now + duration * 0.3); // Decay
            gainNode.gain.linearRampToValueAtTime(volume * 0.7, now + duration * 0.7); // Sustain
            gainNode.gain.linearRampToValueAtTime(0, now + duration); // Release

            oscillator.start(now);
            oscillator.stop(now + duration);
        }

        // Sonido de campana tibetana (m√∫ltiples arm√≥nicos)
        function playBell(baseFreq = 440, duration = 1.5) {
            if (!soundEnabled || !audioContext) return;

            const harmonics = [1, 2.4, 5.5, 8.5]; // Arm√≥nicos de campana
            const volumes = [0.2, 0.1, 0.05, 0.03];

            harmonics.forEach((harmonic, i) => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();

                osc.connect(gain);
                gain.connect(audioContext.destination);

                osc.frequency.value = baseFreq * harmonic;
                osc.type = 'sine';

                const now = audioContext.currentTime;
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(volumes[i], now + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.001, now + duration);

                osc.start(now);
                osc.stop(now + duration);
            });
        }

        // Sonidos espec√≠ficos para cada fase de respiraci√≥n
        const breathingSounds = {
            inhale: () => {
                // Tono ascendente suave (Do -> Mi)
                playTone(261.63, 0.3, 'sine', 0.2); // Do
                setTimeout(() => playTone(329.63, 0.3, 'sine', 0.15), 100); // Mi
            },
            hold: () => {
                // Tono sostenido medio (Sol)
                playTone(392, 0.4, 'sine', 0.15);
            },
            exhale: () => {
                // Tono descendente suave (Mi -> Do)
                playTone(329.63, 0.3, 'sine', 0.2); // Mi
                setTimeout(() => playTone(261.63, 0.4, 'sine', 0.15), 100); // Do
            },
            complete: () => {
                // Campana suave al completar
                playBell(523.25, 2); // Do alto
            },
            tick: () => {
                // Click suave cada segundo
                playTone(880, 0.05, 'sine', 0.08);
            }
        };

        // Sonidos de feedback para respuestas y completar t√©cnicas
        const feedbackSounds = {
            correct: () => {
                // Acorde mayor ascendente (Do-Mi-Sol) - sensaci√≥n de logro
                initAudio();
                playTone(523.25, 0.15, 'sine', 0.15); // Do
                setTimeout(() => playTone(659.25, 0.15, 'sine', 0.12), 80); // Mi
                setTimeout(() => playTone(783.99, 0.25, 'sine', 0.1), 160); // Sol
            },
            incorrect: () => {
                // Dos tonos descendentes suaves - sin ser punitivo
                initAudio();
                playTone(392, 0.2, 'sine', 0.12); // Sol
                setTimeout(() => playTone(349.23, 0.3, 'sine', 0.1), 150); // Fa
            },
            techniqueComplete: () => {
                // Campana de celebraci√≥n
                initAudio();
                playBell(659.25, 1.8); // Mi alto
                setTimeout(() => playTone(783.99, 0.4, 'sine', 0.08), 300); // Sol suave
            },
            xpGain: () => {
                // Sonido tipo "coin" para XP
                initAudio();
                playTone(987.77, 0.08, 'sine', 0.12); // Si alto
                setTimeout(() => playTone(1318.51, 0.12, 'sine', 0.1), 60); // Mi m√°s alto
            },
            roundComplete: () => {
                // Fanfarria suave al completar ronda
                initAudio();
                playTone(523.25, 0.12, 'sine', 0.15);
                setTimeout(() => playTone(659.25, 0.12, 'sine', 0.12), 100);
                setTimeout(() => playTone(783.99, 0.12, 'sine', 0.12), 200);
                setTimeout(() => playBell(1046.50, 1.5), 300); // Do muy alto
            }
        };

        // Load/Save
        function loadState() {
            const saved = localStorage.getItem('detectorEstados');
            if (saved) {
                const data = JSON.parse(saved);
                gameState.totalXP = data.totalXP || 0;
                gameState.totalRounds = data.totalRounds || 0;
                gameState.totalCorrect = data.totalCorrect || 0;
            }
            updateStartScreen();
        }

        function saveState() {
            localStorage.setItem('detectorEstados', JSON.stringify({
                totalXP: gameState.totalXP,
                totalRounds: gameState.totalRounds,
                totalCorrect: gameState.totalCorrect
            }));
        }

        function updateStartScreen() {
            document.getElementById('totalRounds').textContent = gameState.totalRounds;
            document.getElementById('totalXP').textContent = gameState.totalXP;
            const accuracy = gameState.totalRounds > 0
                ? Math.round((gameState.totalCorrect / gameState.totalRounds) * 100)
                : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        // Navigation
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function goBack() {
            if (breathingInterval) clearInterval(breathingInterval);
            window.history.length > 1 ? window.history.back() : window.location.href = '/apps';
        }

        function showStart() {
            showScreen('startScreen');
            updateStartScreen();
        }

        // Game Logic
        function startGame() {
            gameState.currentRound = 0;
            gameState.sessionXP = 0;
            gameState.sessionCorrect = 0;
            usedScenarios = [];
            sessionHistory = []; // Limpiar historial
            nextRound();
        }

        // Guardar respuesta de la ronda actual en el historial
        function saveRoundToHistory() {
            const s = gameState.currentScenario;
            if (!s) return;

            const stateCorrect = gameState.answers.state === s.correctState;
            const techniqueCorrect = gameState.answers.technique === s.bestTechnique;
            const techniqueReasonable = ['breathing', 'grounding', 'pause'].includes(gameState.answers.technique) && s.correctState === 'simpatico';

            sessionHistory.push({
                round: gameState.currentRound,
                scenario: {
                    title: s.title,
                    context: s.context,
                    icon: s.icon
                },
                answers: {
                    sensations: [...gameState.answers.sensations],
                    state: gameState.answers.state,
                    technique: gameState.answers.technique
                },
                correct: {
                    sensations: s.sensations,
                    state: s.correctState,
                    stateName: states.find(st => st.id === s.correctState)?.name || s.correctState,
                    technique: s.bestTechnique,
                    techniqueName: techniques[s.bestTechnique]?.name || s.bestTechnique,
                    stateExplanation: s.stateExplanation,
                    techniqueReason: s.techniqueReason
                },
                results: {
                    stateCorrect,
                    techniqueCorrect: techniqueCorrect || techniqueReasonable
                }
            });
        }

        function nextRound() {
            gameState.currentRound++;
            gameState.currentStep = 0;
            gameState.answers = { bodyZones: [], sensations: [], state: null, technique: null };

            if (gameState.currentRound > gameState.roundsPerSession) {
                showResults();
                return;
            }

            // Pick unused scenario
            const available = scenarios.filter(s => !usedScenarios.includes(s.id));
            if (available.length === 0) usedScenarios = [];
            const pool = available.length > 0 ? available : scenarios;
            gameState.currentScenario = pool[Math.floor(Math.random() * pool.length)];
            usedScenarios.push(gameState.currentScenario.id);

            updateProgress();
            renderScenario();
            showScreen('scenarioScreen');
        }

        function updateProgress() {
            const progress = ((gameState.currentRound - 1) / gameState.roundsPerSession) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('roundDisplay').textContent = `${gameState.currentRound}/${gameState.roundsPerSession}`;
            document.getElementById('xpDisplay').textContent = gameState.sessionXP;
        }

        // SVG icons for scenarios
        const scenarioIcons = {
            'briefcase': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>',
            'users': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
            'presentation': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h20"/><path d="M21 3v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V3"/><path d="m7 21 5-5 5 5"/></svg>',
            'battery-low': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="16" height="10" rx="2" ry="2"/><line x1="22" y1="11" x2="22" y2="13"/><line x1="6" y1="11" x2="6" y2="13"/></svg>',
            'alert-triangle': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
            'sun': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>',
            'phone': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>',
            'user-x': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="18" y1="8" x2="23" y2="13"/><line x1="23" y1="8" x2="18" y2="13"/></svg>'
        };

        function renderScenario() {
            const s = gameState.currentScenario;
            document.getElementById('scenarioIcon').innerHTML = scenarioIcons[s.icon] || scenarioIcons['briefcase'];
            document.getElementById('scenarioTitle').textContent = s.title;
            document.getElementById('scenarioContext').textContent = s.context;

            renderCurrentStep();
        }

        function renderCurrentStep() {
            const container = document.getElementById('questionContainer');
            const s = gameState.currentScenario;
            const step = gameState.currentStep;

            let html = '';

            if (step === 0) {
                // Body sensations - simplified to just selecting sensations
                html = `
                    <div class="question-card">
                        <div class="question-header">
                            <div class="question-number">1</div>
                            <div class="question-text">¬øQu√© sensaciones aparecer√≠an en tu cuerpo?</div>
                        </div>
                        <div class="body-labels" id="sensationOptions">
                            ${s.sensations.concat(['Ninguna especial', 'Energ√≠a positiva', 'Calma total']).map(sens => `
                                <div class="body-label" onclick="toggleSensation(this, '${sens}')">${sens}</div>
                            `).join('')}
                        </div>
                        <div class="feedback-card" id="feedback0"></div>
                    </div>
                `;
            } else if (step === 1) {
                // State recognition
                html = `
                    <div class="question-card">
                        <div class="question-header">
                            <div class="question-number">2</div>
                            <div class="question-text">¬øEn qu√© estado est√° tu sistema nervioso?</div>
                        </div>
                        <div class="options-grid" id="stateOptions">
                            ${states.map(state => `
                                <div class="state-option ${state.color}" onclick="selectState('${state.id}', this)">
                                    <div class="state-indicator"></div>
                                    <div class="state-name">${state.name}</div>
                                    <div class="state-desc">${state.desc}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="feedback-card" id="feedback1"></div>
                    </div>
                `;
            } else if (step === 2) {
                // Si el estado es ventral, no necesita t√©cnica - mostrar mensaje especial
                if (s.correctState === 'ventral') {
                    html = `
                        <div class="technique-section">
                            <div class="technique-badge" style="background: var(--ventral-light); color: var(--ventral);">
                                <span>Estado Ventral</span>
                            </div>
                            <h3 class="technique-title">Ya est√°s regulado</h3>
                            <p class="technique-desc">${s.techniqueReason}</p>

                            <div class="technique-steps">
                                ${techniques.none.steps.map((step, i) => `
                                    <div class="technique-step">
                                        <div class="step-number" style="background: var(--ventral);">${i + 1}</div>
                                        <div class="step-text">${step}</div>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="feedback-card show correct" style="margin-top: 16px;">
                                <div class="feedback-header">
                                    <span class="feedback-icon correct-icon"></span>
                                    <span class="feedback-title">Este es el estado √≥ptimo</span>
                                </div>
                                <p class="feedback-text">No necesitas ninguna t√©cnica. Disfruta y memoriza c√≥mo se siente estar as√≠.</p>
                                <div class="xp-popup">+25 XP</div>
                            </div>
                        </div>
                    `;
                    // Dar XP por reconocer que no necesita t√©cnica
                    gameState.sessionXP += 25;
                    gameState.sessionCorrect += 0.34;
                    updateProgress();
                    container.innerHTML = html;
                    document.getElementById('nextBtn').disabled = false;
                    // Sonido de celebraci√≥n por estar en estado ventral
                    feedbackSounds.correct();
                    return;
                }

                // Technique selection para estados que s√≠ necesitan regulaci√≥n
                const techniqueOptions = Object.entries(techniques)
                    .filter(([key]) => ['breathing', 'grounding', 'pause', 'movement', 'shake'].includes(key))
                    .map(([key, tech]) => `
                        <div class="option-btn" onclick="selectTechnique('${key}', this)">
                            <div class="option-icon">${tech.iconSvg}</div>
                            <div class="option-content">
                                <div class="option-title">${tech.name}</div>
                                <div class="option-desc">${tech.desc}</div>
                            </div>
                        </div>
                    `).join('');

                html = `
                    <div class="question-card">
                        <div class="question-header">
                            <div class="question-number">3</div>
                            <div class="question-text">¬øQu√© t√©cnica usar√≠as para regularte?</div>
                        </div>
                        <div class="options-grid" id="techniqueOptions">
                            ${techniqueOptions}
                        </div>
                        <div class="feedback-card" id="feedback2"></div>
                    </div>
                `;
            } else if (step === 3) {
                // Si es ventral, saltar este paso (ya se manej√≥ en step 2)
                if (s.correctState === 'ventral') {
                    saveRoundToHistory();
                    nextRound();
                    return;
                }

                // Practice the technique
                const tech = techniques[gameState.currentScenario.bestTechnique];
                html = `
                    <div class="technique-section">
                        <div class="technique-badge">
                            <span>Pr√°ctica</span>
                        </div>
                        <h3 class="technique-title">${tech.name}</h3>
                        <p class="technique-desc">${gameState.currentScenario.techniqueReason}</p>

                        ${gameState.currentScenario.bestTechnique === 'breathing' ? `
                            <div class="breathing-visual" id="breathingVisual">
                                <div class="breathing-text">
                                    <div class="breathing-instruction" id="breathInstruction">Prep√°rate</div>
                                    <div class="breathing-count" id="breathCount">-</div>
                                </div>
                            </div>
                        ` : ''}

                        <div class="technique-steps">
                            ${tech.steps.map((step, i) => `
                                <div class="technique-step">
                                    <div class="step-number">${i + 1}</div>
                                    <div class="step-text">${step}</div>
                                </div>
                            `).join('')}
                        </div>

                        <button class="practice-btn" id="practiceBtn" onclick="startPractice()">
                            ${gameState.currentScenario.bestTechnique === 'breathing' ? 'Iniciar Respiraci√≥n' : 'Marcar como Completado'}
                        </button>
                    </div>
                `;
            }

            container.innerHTML = html;
            document.getElementById('nextBtn').disabled = true;
        }

        // Interactions
        function toggleSensation(el, sensation) {
            el.classList.toggle('selected');
            if (el.classList.contains('selected')) {
                gameState.answers.sensations.push(sensation);
            } else {
                gameState.answers.sensations = gameState.answers.sensations.filter(s => s !== sensation);
            }

            // Enable next if at least one selected
            if (gameState.answers.sensations.length > 0) {
                checkSensationAnswer();
            }
        }

        function checkSensationAnswer() {
            const s = gameState.currentScenario;
            const selected = gameState.answers.sensations;
            const correct = s.sensations;

            // Check if selected correct ones (allow some flexibility)
            const correctSelected = selected.filter(sel => correct.includes(sel)).length;
            const incorrectSelected = selected.filter(sel => !correct.includes(sel)).length;

            const isGood = correctSelected >= 1 && incorrectSelected <= 1;

            const feedback = document.getElementById('feedback0');
            if (isGood) {
                feedback.className = 'feedback-card show correct';
                feedback.innerHTML = `
                    <div class="feedback-header">
                        <span class="feedback-icon correct-icon"></span>
                        <span class="feedback-title">Bien identificado</span>
                    </div>
                    <p class="feedback-text">Reconocer las se√±ales de tu cuerpo es el primer paso para poder regularte.</p>
                    <div class="xp-popup">+10 XP</div>
                `;
                gameState.sessionXP += 10;
                gameState.sessionCorrect += 0.33;
                feedbackSounds.correct();
            } else {
                feedback.className = 'feedback-card show incorrect';
                feedback.innerHTML = `
                    <div class="feedback-header">
                        <span class="feedback-icon info-icon"></span>
                        <span class="feedback-title">Las se√±ales t√≠picas ser√≠an:</span>
                    </div>
                    <p class="feedback-text">${correct.join(', ')}. Practica notando estas sensaciones en tu d√≠a a d√≠a.</p>
                `;
                feedbackSounds.incorrect();
            }

            document.getElementById('nextBtn').disabled = false;
            updateProgress();
        }

        function selectState(stateId, el) {
            document.querySelectorAll('.state-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            gameState.answers.state = stateId;

            const s = gameState.currentScenario;
            const isCorrect = stateId === s.correctState;

            const feedback = document.getElementById('feedback1');
            if (isCorrect) {
                el.classList.add('correct');
                feedback.className = 'feedback-card show correct';
                feedback.innerHTML = `
                    <div class="feedback-header">
                        <span class="feedback-icon correct-icon"></span>
                        <span class="feedback-title">Correcto</span>
                    </div>
                    <p class="feedback-text">${s.stateExplanation}</p>
                    <div class="xp-popup">+15 XP</div>
                `;
                gameState.sessionXP += 15;
                gameState.sessionCorrect += 0.33;
                feedbackSounds.correct();
            } else {
                el.classList.add('incorrect');
                document.querySelector(`.state-option.${s.correctState}`).classList.add('correct');
                feedback.className = 'feedback-card show incorrect';
                feedback.innerHTML = `
                    <div class="feedback-header">
                        <span class="feedback-icon info-icon"></span>
                        <span class="feedback-title">En realidad es ${states.find(st => st.id === s.correctState).name}</span>
                    </div>
                    <p class="feedback-text">${s.stateExplanation}</p>
                `;
                feedbackSounds.incorrect();
            }

            document.getElementById('nextBtn').disabled = false;
            updateProgress();
        }

        function selectTechnique(techId, el) {
            document.querySelectorAll('#techniqueOptions .option-btn').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            gameState.answers.technique = techId;

            const s = gameState.currentScenario;
            const isOptimal = techId === s.bestTechnique;
            const isReasonable = ['breathing', 'grounding', 'pause'].includes(techId) && s.correctState === 'simpatico';

            const feedback = document.getElementById('feedback2');
            if (isOptimal) {
                el.classList.add('correct');
                feedback.className = 'feedback-card show correct';
                feedback.innerHTML = `
                    <div class="feedback-header">
                        <span class="feedback-icon correct-icon"></span>
                        <span class="feedback-title">Elecci√≥n √≥ptima</span>
                    </div>
                    <p class="feedback-text">${s.techniqueReason}</p>
                    <div class="xp-popup">+25 XP</div>
                `;
                gameState.sessionXP += 25;
                gameState.sessionCorrect += 0.34;
                feedbackSounds.correct();
            } else if (isReasonable) {
                feedback.className = 'feedback-card show correct';
                feedback.innerHTML = `
                    <div class="feedback-header">
                        <span class="feedback-icon correct-icon"></span>
                        <span class="feedback-title">Buena opci√≥n</span>
                    </div>
                    <p class="feedback-text">Funcionar√≠a, pero lo ideal ser√≠a: ${techniques[s.bestTechnique].name}. ${s.techniqueReason}</p>
                    <div class="xp-popup">+15 XP</div>
                `;
                gameState.sessionXP += 15;
                gameState.sessionCorrect += 0.17;
                feedbackSounds.correct();
            } else {
                el.classList.add('incorrect');
                feedback.className = 'feedback-card show incorrect';
                feedback.innerHTML = `
                    <div class="feedback-header">
                        <span class="feedback-icon info-icon"></span>
                        <span class="feedback-title">Hay una mejor opci√≥n</span>
                    </div>
                    <p class="feedback-text">Lo ideal ser√≠a: ${techniques[s.bestTechnique].name}. ${s.techniqueReason}</p>
                `;
                feedbackSounds.incorrect();
            }

            document.getElementById('nextBtn').disabled = false;
            updateProgress();
        }

        function startPractice() {
            const tech = gameState.currentScenario.bestTechnique;
            const btn = document.getElementById('practiceBtn');

            // Inicializar audio en la primera interacci√≥n del usuario
            initAudio();

            if (tech === 'breathing') {
                btn.disabled = true;
                btn.textContent = 'Respirando...';

                const visual = document.getElementById('breathingVisual');

                // Fases: inhala (4s, expandir), sost√©n (7s, mantener), exhala (8s, contraer)
                const phases = [
                    { text: 'Inhala', count: 4, scaleStart: 0.85, scaleEnd: 1.15, sound: 'inhale' },
                    { text: 'Sost√©n', count: 7, scaleStart: 1.15, scaleEnd: 1.15, sound: 'hold' },
                    { text: 'Exhala', count: 8, scaleStart: 1.15, scaleEnd: 0.85, sound: 'exhale' }
                ];

                let phase = 0;
                let count = phases[0].count;
                let cycles = 0;
                let phaseStartTime = Date.now();

                // Funci√≥n para actualizar el tama√±o del c√≠rculo
                function updateVisualScale() {
                    const currentPhase = phases[phase];
                    const phaseDuration = currentPhase.count * 1000;
                    const elapsed = Date.now() - phaseStartTime;
                    const progress = Math.min(elapsed / phaseDuration, 1);

                    // Interpolaci√≥n lineal entre scaleStart y scaleEnd
                    const currentScale = currentPhase.scaleStart + (currentPhase.scaleEnd - currentPhase.scaleStart) * progress;
                    visual.style.transform = `scale(${currentScale})`;
                }

                // Funci√≥n para reproducir sonido de fase
                function playPhaseSound(phaseIndex) {
                    const soundKey = phases[phaseIndex].sound;
                    if (breathingSounds[soundKey]) {
                        breathingSounds[soundKey]();
                    }
                }

                document.getElementById('breathInstruction').textContent = phases[0].text;
                document.getElementById('breathCount').textContent = count;

                // Iniciar la animaci√≥n del c√≠rculo
                visual.style.transition = 'none';
                updateVisualScale();

                // Reproducir sonido inicial de "Inhala"
                playPhaseSound(0);

                // Actualizar el c√≠rculo cada 50ms para animaci√≥n suave
                const visualInterval = setInterval(updateVisualScale, 50);

                breathingInterval = setInterval(() => {
                    count--;

                    // Tick suave cada segundo (excepto cuando cambia de fase)
                    if (count > 0) {
                        breathingSounds.tick();
                    }

                    if (count <= 0) {
                        phase = (phase + 1) % 3;
                        if (phase === 0) cycles++;

                        if (cycles >= 2) {
                            clearInterval(breathingInterval);
                            clearInterval(visualInterval);
                            visual.style.transform = 'scale(0.85)';
                            // Sonido de completado
                            breathingSounds.complete();
                            completePractice();
                            return;
                        }

                        count = phases[phase].count;
                        phaseStartTime = Date.now();
                        document.getElementById('breathInstruction').textContent = phases[phase].text;

                        // Reproducir sonido de la nueva fase
                        playPhaseSound(phase);
                    }
                    document.getElementById('breathCount').textContent = count;
                }, 1000);

                // Guardar referencia al intervalo visual para limpiar si es necesario
                breathingInterval.visualInterval = visualInterval;
            } else {
                completePractice();
            }
        }

        function completePractice() {
            const btn = document.getElementById('practiceBtn');
            btn.textContent = 'Completado';
            btn.disabled = true;

            gameState.sessionXP += 10;
            updateProgress();

            // Sonido de t√©cnica completada
            feedbackSounds.techniqueComplete();

            document.getElementById('nextBtn').disabled = false;
        }

        function handleNext() {
            if (breathingInterval) {
                // Limpiar ambos intervalos (contador y visual)
                if (breathingInterval.visualInterval) {
                    clearInterval(breathingInterval.visualInterval);
                }
                clearInterval(breathingInterval);
                breathingInterval = null;
            }

            gameState.currentStep++;

            if (gameState.currentStep > 3) {
                // Guardar la ronda en el historial antes de pasar a la siguiente
                saveRoundToHistory();
                nextRound();
            } else {
                renderCurrentStep();
            }
        }

        function showResults() {
            gameState.totalRounds += gameState.roundsPerSession;
            gameState.totalCorrect += Math.round(gameState.sessionCorrect);
            gameState.totalXP += gameState.sessionXP;
            saveState();

            const accuracy = Math.round((gameState.sessionCorrect / gameState.roundsPerSession) * 100);

            document.getElementById('correctAnswers').textContent = Math.round(gameState.sessionCorrect) + '/' + gameState.roundsPerSession;
            document.getElementById('sessionAccuracy').textContent = accuracy + '%';
            document.getElementById('earnedXP').textContent = '+' + gameState.sessionXP;

            const icon = document.getElementById('resultIcon');
            const title = document.getElementById('resultTitle');
            const message = document.getElementById('resultMessage');

            const checkSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>';
            const arrowSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>';

            if (accuracy >= 80) {
                icon.className = 'result-icon great';
                icon.innerHTML = checkSvg;
                title.textContent = 'Excelente';
                message.textContent = 'Tu capacidad de detectar estados es muy buena. Sigue practicando para que sea autom√°tico.';
            } else if (accuracy >= 50) {
                icon.className = 'result-icon good';
                icon.innerHTML = checkSvg;
                title.textContent = 'Buen progreso';
                message.textContent = 'Vas por buen camino. Con pr√°ctica, reconocer tus estados ser√° cada vez m√°s natural.';
            } else {
                icon.className = 'result-icon good';
                icon.innerHTML = arrowSvg;
                title.textContent = 'Sigue practicando';
                message.textContent = 'Reconocer estados internos es una habilidad que se desarrolla. Cada intento cuenta.';
            }

            // Sonido de sesi√≥n completada
            feedbackSounds.roundComplete();

            // Sincronizar XP con el servidor
            const details = `${gameState.roundsPerSession} rondas, ${accuracy}% precisi√≥n`;
            syncXPToServer(gameState.sessionXP, details);

            showScreen('resultScreen');
        }

        // Toggle Sound
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('soundToggle');
            const onIcon = document.getElementById('soundOnIcon');
            const offIcon = document.getElementById('soundOffIcon');

            if (soundEnabled) {
                btn.classList.remove('muted');
                onIcon.classList.remove('hidden');
                offIcon.classList.add('hidden');
            } else {
                btn.classList.add('muted');
                onIcon.classList.add('hidden');
                offIcon.classList.remove('hidden');
            }

            // Guardar preferencia
            localStorage.setItem('detectorEstados_sound', soundEnabled ? 'on' : 'off');
        }

        // Cargar preferencia de sonido
        function loadSoundPreference() {
            const saved = localStorage.getItem('detectorEstados_sound');
            if (saved === 'off') {
                soundEnabled = false;
                document.getElementById('soundToggle').classList.add('muted');
                document.getElementById('soundOnIcon').classList.add('hidden');
                document.getElementById('soundOffIcon').classList.remove('hidden');
            }
        }

        // Sincronizar XP con el servidor (para sistema premium)
        async function syncXPToServer(xpGained, details) {
            try {
                const response = await fetch('/api/xp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        appName: 'detector-estados',
                        xpGained: xpGained,
                        details: details
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('XP sincronizado:', data);

                    // Si acaba de desbloquear premium, mostrar notificaci√≥n
                    if (data.justUnlockedPremium) {
                        showPremiumUnlockedNotification();
                    }
                }
            } catch (error) {
                // Silenciosamente falla si no hay conexi√≥n o no est√° logueado
                console.log('XP guardado localmente (sin conexi√≥n o sin login)');
            }
        }

        // Notificaci√≥n de premium desbloqueado
        function showPremiumUnlockedNotification() {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                    background: linear-gradient(135deg, #F59E0B, #EA580C); color: white;
                    padding: 16px 24px; border-radius: 16px; z-index: 9999;
                    box-shadow: 0 8px 32px rgba(245, 158, 11, 0.4);
                    display: flex; align-items: center; gap: 12px;
                    animation: slideDown 0.5s ease-out;">
                    <span style="font-size: 24px;">üéâ</span>
                    <div>
                        <div style="font-weight: 700; font-size: 16px;">¬°Premium Desbloqueado!</div>
                        <div style="font-size: 13px; opacity: 0.9;">Accede a contenido exclusivo</div>
                    </div>
                </div>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        // Mostrar pantalla de historial
        function showHistory() {
            renderHistory();
            showScreen('historyScreen');
        }

        // Renderizar el historial de respuestas
        function renderHistory() {
            const container = document.getElementById('historyContent');

            if (sessionHistory.length === 0) {
                container.innerHTML = `
                    <div class="history-card" style="text-align: center; padding: 32px;">
                        <p style="color: var(--text-secondary);">No hay respuestas registradas en esta sesi√≥n.</p>
                    </div>
                `;
                return;
            }

            let html = '';

            sessionHistory.forEach(entry => {
                const stateAnswerName = states.find(s => s.id === entry.answers.state)?.name || entry.answers.state || 'No respondido';
                const techniqueAnswerName = entry.answers.technique ? (techniques[entry.answers.technique]?.name || entry.answers.technique) : 'No aplicable';

                html += `
                    <div class="history-card">
                        <div class="history-round-header">
                            <div class="history-round-number">${entry.round}</div>
                            <div class="history-scenario-title">${entry.scenario.title}</div>
                        </div>

                        <!-- Sensaciones -->
                        <div class="history-item">
                            <div class="history-item-label">Sensaciones identificadas</div>
                            <div class="history-answer">
                                ${entry.answers.sensations.length > 0 ? entry.answers.sensations.join(', ') : 'Ninguna seleccionada'}
                            </div>
                            <div class="history-explanation">
                                <strong>Se√±ales t√≠picas:</strong> ${entry.correct.sensations.join(', ')}
                            </div>
                        </div>

                        <!-- Estado -->
                        <div class="history-item">
                            <div class="history-item-label">Estado del sistema nervioso</div>
                            <div class="history-item-row">
                                <div class="history-answer ${entry.results.stateCorrect ? 'correct' : 'incorrect'}">
                                    ${stateAnswerName}
                                </div>
                                ${!entry.results.stateCorrect ? `
                                    <div class="history-correct-answer">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M20 6L9 17l-5-5"/>
                                        </svg>
                                        ${entry.correct.stateName}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="history-explanation">${entry.correct.stateExplanation}</div>
                        </div>

                        <!-- T√©cnica (solo si no es ventral) -->
                        ${entry.correct.state !== 'ventral' ? `
                            <div class="history-item">
                                <div class="history-item-label">T√©cnica elegida</div>
                                <div class="history-item-row">
                                    <div class="history-answer ${entry.results.techniqueCorrect ? 'correct' : 'incorrect'}">
                                        ${techniqueAnswerName}
                                    </div>
                                    ${!entry.results.techniqueCorrect ? `
                                        <div class="history-correct-answer">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M20 6L9 17l-5-5"/>
                                            </svg>
                                            ${entry.correct.techniqueName}
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="history-explanation">${entry.correct.techniqueReason}</div>
                            </div>
                        ` : `
                            <div class="history-item">
                                <div class="history-item-label">T√©cnica</div>
                                <div class="history-answer correct">
                                    Estado ventral - No requiere regulaci√≥n
                                </div>
                                <div class="history-explanation">${entry.correct.techniqueReason}</div>
                            </div>
                        `}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Init
        loadState();
        loadSoundPreference();
    </script>
</body>
</html>
