<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Lugar Seguro - Regulaci贸n del Sistema Nervioso</title>
    <style>
        :root {
            --bg-primary: #FAF9F7;
            --bg-secondary: #F5F4F0;
            --text-primary: #1A1915;
            --text-secondary: #706F6C;
            --text-muted: #9B9A97;
            --border-color: #E5E4E0;
            --card-bg: #FFFFFF;
            --accent: #2ca58d;
            --accent-light: rgba(44, 165, 141, 0.1);
            --success: #2ca58d;
            --success-light: rgba(44, 165, 141, 0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #121212;
                --bg-secondary: #252525;
                --text-primary: #ECECEC;
                --text-secondary: #B4B4B4;
                --text-muted: #808080;
                --border-color: #333333;
                --card-bg: #1E1E1E;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: none;
            border: none;
            color: var(--accent);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            padding: 8px 0;
        }

        .back-btn svg {
            width: 20px;
            height: 20px;
        }

        .header-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .info-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
        }

        .info-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            text-align: center;
        }

        /* Safe Place Circle */
        .safe-circle {
            width: 220px;
            height: 220px;
            border-radius: 50%;
            background: var(--card-bg);
            box-shadow: 0 0 60px rgba(0,0,0,0.04), 0 0 100px rgba(0,0,0,0.02);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            margin-bottom: 32px;
            transition: all 4s ease-in-out;
        }

        .safe-circle.breathing {
            animation: breathe 8s ease-in-out infinite;
        }

        @keyframes breathe {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 60px rgba(0,0,0,0.04), 0 0 100px rgba(0,0,0,0.02);
            }
            50% {
                transform: scale(1.08);
                box-shadow: 0 0 80px rgba(44, 165, 141, 0.1), 0 0 120px rgba(44, 165, 141, 0.05);
            }
        }

        .circle-icon {
            width: 48px;
            height: 48px;
            color: var(--accent);
            margin-bottom: 8px;
        }

        .circle-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .circle-subtext {
            font-size: 14px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Time Display */
        .time-display {
            font-size: 32px;
            font-weight: 300;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
            margin-bottom: 16px;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            max-width: 300px;
            margin-bottom: 8px;
        }

        .progress-bar-bg {
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #45c4a8);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .time-labels {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 300px;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* Controls */
        .controls-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            padding: 24px;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .control-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-btn svg {
            width: 24px;
            height: 24px;
        }

        .control-btn.secondary {
            width: 52px;
            height: 52px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .control-btn.secondary:active {
            transform: scale(0.95);
        }

        .control-btn.primary {
            width: 76px;
            height: 76px;
            background: var(--accent);
            color: white;
            box-shadow: 0 4px 24px rgba(44, 165, 141, 0.35);
        }

        .control-btn.primary:active {
            transform: scale(0.95);
        }

        .control-btn.primary svg {
            width: 32px;
            height: 32px;
        }

        /* Start Screen */
        .start-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            text-align: center;
        }

        .start-icon {
            width: 100px;
            height: 100px;
            background: var(--accent-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .start-icon svg {
            width: 48px;
            height: 48px;
            color: var(--accent);
        }

        .start-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .start-description {
            font-size: 16px;
            color: var(--text-secondary);
            line-height: 1.6;
            max-width: 320px;
            margin-bottom: 32px;
        }

        .feature-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 40px;
            text-align: left;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .feature-item svg {
            width: 20px;
            height: 20px;
            color: var(--success);
            flex-shrink: 0;
        }

        .start-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 48px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(44, 165, 141, 0.3);
        }

        .start-btn:active {
            transform: scale(0.98);
        }

        .start-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Player Screen */
        .player-screen {
            display: none;
            flex-direction: column;
            flex: 1;
        }

        .player-screen.visible {
            display: flex;
        }

        /* Completion Screen */
        .completion-screen {
            flex: 1;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            text-align: center;
        }

        .completion-screen.visible {
            display: flex;
        }

        .completion-icon {
            width: 100px;
            height: 100px;
            background: var(--success-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            animation: scaleIn 0.5s ease;
        }

        @keyframes scaleIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .completion-icon svg {
            width: 48px;
            height: 48px;
            color: var(--success);
        }

        .completion-title {
            font-size: 26px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .completion-text {
            font-size: 16px;
            color: var(--text-secondary);
            line-height: 1.6;
            max-width: 300px;
            margin-bottom: 32px;
        }

        .completion-btn {
            padding: 16px 48px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(44, 165, 141, 0.3);
        }

        /* Info Panel */
        .info-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .info-panel.visible {
            opacity: 1;
            visibility: visible;
        }

        .info-content {
            background: var(--card-bg);
            border-radius: 24px 24px 0 0;
            padding: 24px;
            padding-bottom: calc(24px + env(safe-area-inset-bottom));
            width: 100%;
            max-width: 500px;
            max-height: 70vh;
            overflow-y: auto;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .info-panel.visible .info-content {
            transform: translateY(0);
        }

        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .info-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .close-btn {
            background: var(--bg-secondary);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .close-btn svg {
            width: 18px;
            height: 18px;
            color: var(--text-secondary);
        }

        .info-section {
            margin-bottom: 16px;
        }

        .info-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .info-section p, .info-section li {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .info-section ul {
            padding-left: 18px;
        }

        .info-section li {
            margin-bottom: 4px;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Hidden Audio Element -->
    <audio id="audioPlayer" preload="auto">
        <source src="https://pub-5117fbee94844f5a8a08f061ad7ff61c.r2.dev/audios%20apps/Audio%20lugar%20seguro%20app.mp3" type="audio/mpeg">
    </audio>

    <!-- Header -->
    <header class="header">
        <button class="back-btn" onclick="handleBack()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M15 18l-6-6 6-6"/>
            </svg>
            <span>Volver</span>
        </button>
        <span class="header-title">Lugar Seguro</span>
        <button class="info-btn" onclick="toggleInfo()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4"/>
                <path d="M12 8h.01"/>
            </svg>
        </button>
    </header>

    <!-- Start Screen -->
    <div class="start-screen" id="startScreen">
        <div class="start-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <!-- Lucide Shield icon -->
                <path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/>
            </svg>
        </div>
        <h1 class="start-title">Lugar Seguro</h1>
        <p class="start-description">
            Crea un refugio mental al que puedes volver en cualquier momento para encontrar calma y seguridad.
        </p>

        <div class="feature-list">
            <div class="feature-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                <span>Audio guiado - cierra los ojos</span>
            </div>
            <div class="feature-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                <span>Visualiza tu espacio de calma</span>
            </div>
            <div class="feature-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                <span>Ancla las sensaciones de seguridad</span>
            </div>
        </div>

        <button class="start-btn" onclick="startSession()">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <polygon points="5 3 19 12 5 21 5 3"/>
            </svg>
            <span>Comenzar</span>
        </button>
    </div>

    <!-- Player Screen -->
    <div class="player-screen" id="playerScreen">
        <div class="main-content">
            <div class="safe-circle breathing" id="safeCircle">
                <svg class="circle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <!-- Lucide Shield icon -->
                    <path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/>
                </svg>
                <span class="circle-text" id="circleText">Tu refugio</span>
                <span class="circle-subtext" id="circleSubtext">Rel谩jate y visualiza</span>
            </div>

            <div class="time-display" id="timeDisplay">0:00</div>

            <div class="progress-container">
                <div class="progress-bar-bg" onclick="seekAudio(event)" id="progressBarBg">
                    <div class="progress-bar-fill" id="progressBar"></div>
                </div>
            </div>
            <div class="time-labels">
                <span id="currentTime">0:00</span>
                <span id="totalTime">0:00</span>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-bar">
            <button class="control-btn secondary" onclick="rewind()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                    <path d="M3 3v5h5"/>
                </svg>
            </button>
            <button class="control-btn primary" id="playPauseBtn" onclick="togglePlayPause()">
                <svg id="pauseIcon" viewBox="0 0 24 24" fill="currentColor">
                    <rect x="6" y="4" width="4" height="16" rx="1"/>
                    <rect x="14" y="4" width="4" height="16" rx="1"/>
                </svg>
                <svg id="playIcon" viewBox="0 0 24 24" fill="currentColor" class="hidden">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
            </button>
            <button class="control-btn secondary" onclick="forward()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                    <path d="M21 3v5h-5"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Completion Screen -->
    <div class="completion-screen" id="completionScreen">
        <div class="completion-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        </div>
        <h2 class="completion-title">Lugar Seguro Instalado</h2>
        <p class="completion-text">
            Tu refugio est谩 listo. Puedes volver a 茅l en cualquier momento cerrando los ojos y recordando las sensaciones.
        </p>
        <button class="completion-btn" onclick="resetToStart()">Terminar</button>
    </div>

    <!-- Info Panel -->
    <div class="info-panel" id="infoPanel">
        <div class="info-content">
            <div class="info-header">
                <h2>Sobre el Lugar Seguro</h2>
                <button class="close-btn" onclick="toggleInfo()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="info-section">
                <h3>驴Qu茅 es?</h3>
                <p>El Lugar Seguro es una t茅cnica de visualizaci贸n que crea un refugio mental. Es un recurso de anclaje que puedes usar en cualquier momento para encontrar calma.</p>
            </div>
            <div class="info-section">
                <h3>Beneficios</h3>
                <ul>
                    <li>Reduce la activaci贸n del sistema nervioso</li>
                    <li>Promueve estados de calma y seguridad</li>
                    <li>Recurso portable que puedes usar en cualquier lugar</li>
                    <li>Fortalece la autorregulaci贸n emocional</li>
                </ul>
            </div>
            <div class="info-section">
                <h3>C贸mo practicar</h3>
                <p>Encuentra un lugar tranquilo, cierra los ojos y deja que el audio te gu铆e para crear y anclar tu espacio interno de seguridad.</p>
            </div>
        </div>
    </div>

    <script>
        // Elements
        const audio = document.getElementById('audioPlayer');
        const progressBar = document.getElementById('progressBar');
        const timeDisplay = document.getElementById('timeDisplay');
        const currentTimeLabel = document.getElementById('currentTime');
        const totalTimeLabel = document.getElementById('totalTime');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const safeCircle = document.getElementById('safeCircle');

        let isPlaying = false;

        // Format time (seconds to M:SS)
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        // Update progress bar and time
        function updateProgress() {
            if (audio.duration) {
                const percent = (audio.currentTime / audio.duration) * 100;
                progressBar.style.width = `${percent}%`;
                timeDisplay.textContent = formatTime(audio.currentTime);
                currentTimeLabel.textContent = formatTime(audio.currentTime);
            }
        }

        // Audio event listeners
        audio.addEventListener('loadedmetadata', () => {
            totalTimeLabel.textContent = formatTime(audio.duration);
        });

        audio.addEventListener('timeupdate', updateProgress);

        audio.addEventListener('ended', () => {
            isPlaying = false;
            updatePlayPauseButton();
            safeCircle.classList.remove('breathing');
            showCompletion();
        });

        audio.addEventListener('play', () => {
            isPlaying = true;
            updatePlayPauseButton();
            safeCircle.classList.add('breathing');
        });

        audio.addEventListener('pause', () => {
            isPlaying = false;
            updatePlayPauseButton();
            safeCircle.classList.remove('breathing');
        });

        // Start session
        function startSession() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('playerScreen').classList.add('visible');
            audio.play();
        }

        // Toggle play/pause
        function togglePlayPause() {
            if (isPlaying) {
                audio.pause();
            } else {
                audio.play();
            }
        }

        // Update play/pause button icon
        function updatePlayPauseButton() {
            playIcon.classList.toggle('hidden', isPlaying);
            pauseIcon.classList.toggle('hidden', !isPlaying);
        }

        // Seek audio
        function seekAudio(event) {
            const progressBarBg = document.getElementById('progressBarBg');
            const rect = progressBarBg.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            audio.currentTime = percent * audio.duration;
        }

        // Rewind 15 seconds
        function rewind() {
            audio.currentTime = Math.max(0, audio.currentTime - 15);
        }

        // Forward 15 seconds
        function forward() {
            audio.currentTime = Math.min(audio.duration, audio.currentTime + 15);
        }

        // Show completion screen
        function showCompletion() {
            document.getElementById('playerScreen').classList.remove('visible');
            document.getElementById('completionScreen').classList.add('visible');

            // Sincronizar XP - 30 XP por completar visualizaci贸n
            syncXPToServer(30, 'Visualizaci贸n completada');
        }

        // Sincronizar XP con el servidor
        async function syncXPToServer(xpGained, details) {
            try {
                const response = await fetch('/api/xp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        appName: 'lugar-seguro',
                        xpGained: xpGained,
                        details: details
                    })
                });
                if (response.ok) {
                    const data = await response.json();
                    console.log('XP sincronizado:', data);
                    if (data.justUnlockedPremium) {
                        showPremiumNotification();
                    }
                }
            } catch (e) {
                console.log('XP guardado localmente');
            }
        }

        function showPremiumNotification() {
            const n = document.createElement('div');
            n.innerHTML = '<div style="position:fixed;top:20px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,#F59E0B,#EA580C);color:white;padding:16px 24px;border-radius:16px;z-index:9999;box-shadow:0 8px 32px rgba(245,158,11,0.4);display:flex;align-items:center;gap:12px"><span style="font-size:24px"></span><div><div style="font-weight:700">隆Premium Desbloqueado!</div><div style="font-size:13px;opacity:0.9">Accede a contenido exclusivo</div></div></div>';
            document.body.appendChild(n);
            setTimeout(() => n.remove(), 5000);
        }

        // Reset to start
        function resetToStart() {
            document.getElementById('completionScreen').classList.remove('visible');
            document.getElementById('startScreen').classList.remove('hidden');
            audio.currentTime = 0;
            progressBar.style.width = '0%';
            timeDisplay.textContent = '0:00';
            currentTimeLabel.textContent = '0:00';
        }

        // Toggle info panel
        function toggleInfo() {
            document.getElementById('infoPanel').classList.toggle('visible');
        }

        // Handle back button
        function handleBack() {
            audio.pause();
            if (window.history.length > 1) {
                window.history.back();
            } else {
                window.location.href = '/apps';
            }
        }

        // Close info panel when clicking outside
        document.getElementById('infoPanel').addEventListener('click', function(e) {
            if (e.target === this) {
                toggleInfo();
            }
        });
    </script>
</body>
</html>
